<?php

namespace YB\IxinaBundle\Repository;

/**
 * CustomerRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class CustomerRepository extends \Doctrine\ORM\EntityRepository
{
    public function ClientsToday()
    {
        $qb = $this->createQueryBuilder('c');
        $qb->Where('c.dateProchaineAction = :today')
            ->setParameter('today', new \DateTime(date('Y-m-d')))
            ->andWhere('c.etatDossier = :etat')
            ->setParameter('etat', 'Prospect')
            ;
        return $qb->getQuery()->getResult();
    }

    public function ClientsByDateAction()
    {
        $qb = $this->createQueryBuilder('c');
        $qb->orderBy('c.dateProchaineAction', 'ASC');
        return $qb->getQuery()->getResult();
    }

    public function ClientsByDateCreation()
    {
        $qb = $this->createQueryBuilder('c');
        $qb->orderBy('c.dateCreation', 'DESC');
        return $qb->getQuery()->getResult();
    }

    public function ProspectByDateAction()
    {
        $qb = $this->createQueryBuilder('c')
            ->Where('c.etatDossier = :etat')
            ->setParameter('etat', 'Prospect')
            ->orderBy('c.dateProchaineAction', 'ASC');
        return $qb->getQuery()->getResult();
    }

    public function ClientsDessin()
    {
        $qb = $this->createQueryBuilder('c');
        $qb->Where('c.dessin = :dessin')
            ->setParameter('dessin', false)
            ->orderBy('c.dateProchaineAction', 'ASC');
        $this->MoisEnCours($qb);
        return $qb->getQuery()->getResult();
    }

    public function ClientsPreparer()
    {
        $qb = $this->createQueryBuilder('c')
            ->Where('c.preparation = :preparation')
            ->setParameter('preparation', false)
            ->orderBy('c.dateProchaineAction', 'ASC');
        $this->MoisEnCours($qb);
        return $qb->getQuery()->getResult();
    }

    public function firstDessin()
    {
        $qb = $this->createQueryBuilder('c')
            ->Where('c.dessin = :dessin')
            ->setParameter('dessin', false)
            ->orderBy('c.dateProchaineAction', 'ASC');
            $this->MoisEnCours($qb);
            return $qb->getQuery()->getResult();
    }

    public function firstPreparation()
    {
        $qb = $this->createQueryBuilder('c')
            ->Where('c.preparation = :preparation')
            ->setParameter('preparation', false)
            ->orderBy('c.dateProchaineAction', 'ASC');
            $this->MoisEnCours($qb);
            return $qb->getQuery()->getResult();
    }

/* Récupération lié au mois en cours */

    public function ClientsPerduMoisEnCours()
    {
        $qb = $this->createQueryBuilder('c')
            ->Where('c.etatDossier = :etat')
            ->setParameter('etat', 'Perdu')
            ->orderBy('c.dateProchaineAction', 'ASC');
            $this->MoisEnCours($qb);
        return $qb->getQuery()->getResult();
    }

    public function ClientsVenduMoisEnCours()
    {
        $qb = $this->createQueryBuilder('c')
            ->Where('c.etatDossier = :etat')
            ->setParameter('etat', 'Vendu')
            ->orderBy('c.dateProchaineAction', 'ASC');
            $this->MoisEnCours($qb);
        return $qb->getQuery()->getResult();
    }

    public function ClientsProspectMoisEnCours()
    {
        $qb = $this->createQueryBuilder('c')
            ->Where('c.etatDossier = :etat')
            ->setParameter('etat', 'Prospect')
            ->orderBy('c.dateProchaineAction', 'ASC');
        $this->MoisEnCours($qb);
        return $qb->getQuery()->getResult();
    }

    public function NewProspectDuMois()
    {
        $qb = $this->createQueryBuilder('c')
            ->Where('c.dateCreation BETWEEN :debut AND :fin')
            ->setParameter('debut', new \dateTime(date('Y-M').'-01'))
            ->setParameter('fin', new \dateTime(date(date('Y-m').'-00').'+1 month'))
            ;
        return $qb->getQuery()->getResult();
    }

    public function ClientsRetourDuMois()
    {
         $qb = $this->createQueryBuilder('c')
            ->Where('c.etatDossier = :etat')
            ->setParameter('etat', 'Prospect')
            ->andWhere('c.action = :action')
            ->setParameter('action', 'Retour')
            ->orderBy('c.dateProchaineAction', 'ASC');
            $this->MoisEnCours($qb);
        return $qb->getQuery()->getResult();
    }

    public function MoisEnCours($qb)
    {
    
        $qb->andWhere('c.dateProchaineAction BETWEEN :debut AND :fin')
            ->setParameter('debut', new \dateTime(date(date('Y-m').'-01')))
            ->setParameter('fin', new \dateTime(date(date('Y-m').'-00').'+1 month'))
            ;
    }

/* récupération des données avant ou après le mois en cours */

    public function avantMoisEnCours($qb)
    {
        $qb->andWhere('c.dateProchaineAction < :date')
            ->setParameter('date', new \dateTime(date('Y-m').'-01'))
            ;
    }

    public function apresMoisEnCours($qb)
    {
        $qb->andWhere('c.dateProchaineAction > :date')
            ->setParameter('date', new \dateTime(date('Y-m').'-00 +1 month'))
            ;
    }

    public function clientsAvantMoisEnCours()
    {
        $qb = $this->createQueryBuilder('c');
        $this->avantMoisEnCours($qb);
        return $qb->getQuery()->getResult();
    }

    public function clientsApresMoisEnCours()
    {
        $qb = $this->createQueryBuilder('c');
        $this->apresMoisEnCours($qb);
        return $qb->getQuery()->getResult();
    }

}
